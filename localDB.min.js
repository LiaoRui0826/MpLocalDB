// 小程序本地数据库 https://github.com/jin-yufeng/MpLocalDB
function _writeBack(){_dirty=!0,setTimeout(function(){_dirty&&(_dirty=!1,wx.setStorage({data:localDB,key:"localDB"}))},200)}function _update(t,n){for(var o in n)"function"==typeof n[o]?t[o]=n[o](t[o]):t[o]=n[o]}function _randomId(){for(var t="",n=0;n<4;n++)t+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"[parseInt(62*Math.random())];return t}function Collection(t,n){this.data=t,this._super=n||t}function Command(t){this.exec=t}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},localDB,_dirty=!1;Collection.prototype.add=function(t){var n=t._id;if("object"!=(void 0===t?"undefined":_typeof(t))||this.data[n])return null;for(t=JSON.parse(JSON.stringify(t)),t._id=void 0;!n||this.data[n];)n=_randomId();return this.data[n]=t,_writeBack(),n},Collection.prototype.doc=function(t){var n=this,o=this.data[t];return{get:function(){var n=JSON.parse(JSON.stringify(o));return n._id=t,n},update:function(t){return"object"==(void 0===t?"undefined":_typeof(t))&&(_update(o,t),_writeBack(),!0)},remove:function(){return n.data[t]=void 0,!0}}},Collection.prototype.where=function(t){var n={};for(var o in this.data){var r=!0;for(var e in t){var i="_id"==e?o:this.data[o][e];"object"==_typeof(t[e])&&(t[e]instanceof Command||t[e]instanceof RegExp)?t[e].exec(i)||(r=!1):t[e]!=i&&(r=!1)}r&&(n[o]=this.data[o])}return new Collection(n,this._super)},Collection.prototype.limit=function(t){return this._limit=t,this},Collection.prototype.skip=function(t){return this._skip=t,this},Collection.prototype.orderBy=function(t,n){return this._field=t,this._order=n||"asc",this},Collection.prototype.count=function(){var t=0;for(var n in this.data)this.data[n]&&t++;return t},Collection.prototype.get=function(){var t=this,n=[],o=0;for(var r in this.data){if(!this._skip||o>=this._skip){var e=this.data[r];if(e&&(e=JSON.parse(JSON.stringify(e)),e._id=r,n.push(e)),o+1-(this._skip||0)==this._limit)break}o++}return this._field&&n.sort(function(n,o){return"desc"==t._order?o[t._field]-n[t._field]:n[t._field]-o[t._field]}),n},Collection.prototype.update=function(t){if("object"!=(void 0===t?"undefined":_typeof(t)))return!1;for(var n in this.data)_update(this.data[n],t);return _writeBack(),!0},Collection.prototype.remove=function(){for(var t in this.data)this._super[t]=void 0;_writeBack()},Command.prototype.and=function(t){var n=this;return new Command(function(o){return n.exec(o)&&t.exec(o)})},Command.prototype.or=function(t){var n=this;return new Command(function(o){return n.exec(o)||t.exec(o)})},module.exports={init:function(){localDB||(localDB=wx.getStorageSync("localDB")||{})},createCollection:function(t){return localDB?!localDB[t]&&(localDB[t]={},_writeBack(),new Collection(localDB[t])):(console.warn("请先初始化"),!1)},removeCollection:function(t){if(!localDB)return console.warn("请先初始化");localDB[t]=void 0,_writeBack()},collection:function(t){return localDB?localDB[t]?new Collection(localDB[t]):null:(console.warn("请先初始化"),!1)},command:{eq:function(t){return new Command(function(n){return n==t})},neq:function(t){return new Command(function(n){return n!=t})},lt:function(t){return new Command(function(n){return n<t})},lte:function(t){return new Command(function(n){return n<=t})},gt:function(t){return new Command(function(n){return n>t})},gte:function(t){return new Command(function(n){return n>=t})},in:function(t){return new Command(function(n){return t.includes(n)})},nin:function(t){return new Command(function(n){return!t.includes(n)})},exists:function(t){return new Command(function(n){return void 0==n?!t:t})},set:function(t){return JSON.parse(JSON.stringify(t))},remove:function(){},inc:function(t){return function(n){return n+=t}},mul:function(t){return function(n){return n*=t}},push:function(t){return function(n){return n.push(t),n}},pop:function(){return function(t){return t.pop(),t}},shift:function(){return function(t){return t.shift(),t}},unshift:function(t){return function(n){return n.unshift(t),n}}}};