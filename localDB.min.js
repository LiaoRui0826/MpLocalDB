// 小程序本地数据库 https://github.com/jin-yufeng/MpLocalDB
function _writeBack(){_dirty=!0,setTimeout(function(){_dirty&&(_dirty=!1,wx.setStorage({data:localDB,key:"localDB"}))},200)}function _update(t,n){for(var o in n)"function"==typeof n[o]?t[o]=n[o](t[o]):t[o]=n[o]}function _randomId(){for(var t="",n=0;n<4;n++)t+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"[parseInt(62*Math.random())];return t}function Collection(t,n,o){this.data=t,this.options=o||{orderBy:[]},this.root=n||t}function Command(t){this.exec=t}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},localDB,_dirty=!1;Collection.prototype.add=function(t){var n=t._id;if("object"!=(void 0===t?"undefined":_typeof(t))||this.data[n])return null;for(t=JSON.parse(JSON.stringify(t)),t._id=void 0;!n||this.data[n];)n=_randomId();return this.data[n]=t,_writeBack(),n},Collection.prototype.doc=function(t){var n=this,o=this.data[t];return{get:function(){var n=JSON.parse(JSON.stringify(o));return n._id=t,n},update:function(t){return"object"==(void 0===t?"undefined":_typeof(t))&&(_update(o,t),_writeBack(),!0)},remove:function(){return n.data[t]=void 0,!0}}},Collection.prototype.where=function(t){var n={};for(var o in this.data){var i=!0;for(var r in t){var e="_id"==r?o:this.data[o][r];"object"==_typeof(t[r])&&(t[r]instanceof Command||t[r]instanceof RegExp)?t[r].exec(e)||(i=!1):t[r]!=e&&(i=!1)}i&&(n[o]=this.data[o])}return new Collection(n,this.root,this.options)},Collection.prototype.limit=function(t){var n=JSON.parse(JSON.stringify(this.options));return n.limit=t,new Collection(this.data,this.root,n)},Collection.prototype.skip=function(t){var n=JSON.parse(JSON.stringify(this.options));return n.skip=t,new Collection(this.data,this.root,n)},Collection.prototype.orderBy=function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"asc",o=JSON.parse(JSON.stringify(this.options));return o.orderBy.push({field:t,order:n}),new Collection(this.data,this.root,o)},Collection.prototype.count=function(){var t=0;for(var n in this.data)this.data[n]&&t++;return t},Collection.prototype.get=function(){var t=this,n=[],o=function(o){var i=t.data[o];i&&(i=JSON.parse(JSON.stringify(i)),i._id=o,n.push(i))};if(this.options.orderBy.length){for(var i in this.data)o(i);n.sort(function(n,o){for(var i,r=0;(i=t.options.orderBy[r]);r++)if(n[i.field]!=o[i.field])return"desc"==i.order?o[i.field]-n[i.field]:n[i.field]-o[i.field];return 0}),this.options.skip&&(n=n.slice(this.options.skip)),this.options.limit&&(n=n.slice(0,this.options.limit))}else{var r;for(var e in this.data){if((!this.options.skip||r>=this.options.skip)&&(o(e),r+1-(this.options.skip||0)==this.options.limit))break;r++}}return n},Collection.prototype.update=function(t){if("object"!=(void 0===t?"undefined":_typeof(t)))return!1;for(var n in this.data)_update(this.data[n],t);return _writeBack(),!0},Collection.prototype.remove=function(){for(var t in this.data)this.root[t]=void 0;_writeBack()},Command.prototype.and=function(t){var n=this;return new Command(function(o){return n.exec(o)&&t.exec(o)})},Command.prototype.or=function(t){var n=this;return new Command(function(o){return n.exec(o)||t.exec(o)})},module.exports={init:function(){localDB||(localDB=wx.getStorageSync("localDB")||{})},createCollection:function(t){return localDB?!localDB[t]&&(localDB[t]={},_writeBack(),new Collection(localDB[t])):(console.warn("请先初始化"),!1)},removeCollection:function(t){if(!localDB)return console.warn("请先初始化");localDB[t]=void 0,_writeBack()},collection:function(t){return localDB?localDB[t]?new Collection(localDB[t]):null:(console.warn("请先初始化"),!1)},command:{eq:function(t){return new Command(function(n){return n==t})},neq:function(t){return new Command(function(n){return n!=t})},lt:function(t){return new Command(function(n){return n<t})},lte:function(t){return new Command(function(n){return n<=t})},gt:function(t){return new Command(function(n){return n>t})},gte:function(t){return new Command(function(n){return n>=t})},in:function(t){return new Command(function(n){return t.includes(n)})},nin:function(t){return new Command(function(n){return!t.includes(n)})},exists:function(t){return new Command(function(n){return void 0==n?!t:t})},set:function(t){return JSON.parse(JSON.stringify(t))},remove:function(){},inc:function(t){return function(n){return n+=t}},mul:function(t){return function(n){return n*=t}},push:function(t){return function(n){return n.push(t),n}},pop:function(){return function(t){return t.pop(),t}},shift:function(){return function(t){return t.shift(),t}},unshift:function(t){return function(n){return n.unshift(t),n}}}};